<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="utf-8">
  <title>Test Nearby Observations</title>
  <style>
    body { font-family: sans-serif; margin: 2em; }
    ul { padding-left: 1.5em; }
    li { margin-bottom: 0.5em; }
    label { display: block; margin-top: 1em; }
  </style>
</head>
<body>
  <h1>Test Nearby Observations</h1>
  <form id="nearbyForm">
    <label>
      Radius (km):
      <input type="number" id="radius_km" value="10">
    </label>
    <button type="button" id="geoBtn">Brug min lokation</button>
    <button type="submit">Hent observationer</button>
    <div id="geoStatus"></div>
    <input type="hidden" id="lat">
    <input type="hidden" id="lng">
  </form>
  <h2>Resultat</h2>
  <ul id="result"></ul>
  <script>
    // Hent user_id og device_id fra localStorage
    function getUserId() {
      return localStorage.getItem('userid') || 'test-user';
    }
    function getDeviceId() {
      return localStorage.getItem('deviceid') || 'test-device';
    }

    document.getElementById('geoBtn').onclick = function(e) {
      e.preventDefault();
      const geoStatus = document.getElementById('geoStatus');
      geoStatus.textContent = "Henter din position...";
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(pos) {
          document.getElementById('lat').value = pos.coords.latitude;
          document.getElementById('lng').value = pos.coords.longitude;
          geoStatus.textContent = `Din position: ${pos.coords.latitude}, ${pos.coords.longitude}`;
        }, function(err) {
          geoStatus.textContent = "Kunne ikke hente position: " + err.message;
        });
      } else {
        geoStatus.textContent = "Geolocation understøttes ikke.";
      }
    };

    document.getElementById('nearbyForm').onsubmit = async function(e) {
      e.preventDefault();
      const user_id = getUserId();
      const device_id = getDeviceId();
      const lat = document.getElementById('lat').value;
      const lng = document.getElementById('lng').value;
      const radius_km = document.getElementById('radius_km').value;
      if (!lat || !lng) {
        document.getElementById('geoStatus').textContent = "Du skal vælge din position først!";
        return;
      }
      const res = await fetch('/api/nearby-observations', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ user_id, device_id, lat, lng, radius_km })
      });
      const data = await res.json();
      const ul = document.getElementById('result');
      ul.innerHTML = '';
      if (data.observations && data.observations.length) {
        data.observations.forEach(obs => {
          const li = document.createElement('li');
          li.textContent = `${obs.Antal || '?'} ${obs.Artnavn || ''}, ${obs.Loknavn || ''} (${obs.Dato || ''})`;
          ul.appendChild(li);
        });
      } else {
        ul.innerHTML = '<li>Ingen observationer fundet.</li>';
      }
    };
  </script>
</body>
</html>